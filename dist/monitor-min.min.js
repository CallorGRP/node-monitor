/* monitor-min - v0.5.4 - 2013-06-28 */
(function(e){var t=typeof exports!="undefined",n=t?require("backbone"):e.Backbone,r=t?require("underscore")._:e._,i=null,s=null,o=t?require("cron"):null,u=4,a=n.Model.extend({defaults:{id:"",name:"",probeClass:"",initParams:{},hostName:"",appName:"",appInstance:""},initialize:function(e,t){i.info("init",e)},connect:function(e){var t=this,n=Date.now();i.info("connect",t.toMonitorJSON()),a.getRouter().connectMonitor(t,function(r){e&&e(r),r?i.error("connect",r):(t.trigger("connect",t),t.trigger("change",t),i.info("connected",t.toMonitorJSON()),s.time("connect",Date.now()-n))})},getConnection:function(){var e=this;return e.probe&&e.probe.connection?e.probe.connection:null},isConnected:function(){var e=this;return e.probe!=null},disconnect:function(e){var t=this,n="manual_disconnect",r=Date.now();i.info("disconnect",n,t.get("id")),a.getRouter().disconnectMonitor(t,n,function(n,o){e&&e(n),n?i.error("disconnect",n):(t.trigger("disconnect",o),i.info("disconnected",t.toMonitorJSON()),s.time("disconnect",Date.now()-r))})},control:function(e,t,n){var r=this,o=r.probe,u="control."+r.get("probeClass")+"."+e+"."+r.get("id"),a=Date.now();typeof t=="function"&&(n=t,t=null),i.info(u,t);var f=function(e,t){e?i.error(u,e):(i.info("return."+u,t),s.time(u,Date.now()-a)),n&&n.apply(r,arguments)};if(!o)return f("Probe not connected");o.connection?o.connection.emit("probe:control",{probeId:r.get("probeId"),name:e,params:t},f):o.onControl(e,t,f)},toProbeJSON:function(e){var t=this,n={id:t.get("probeId")};return r.each(t.toJSON(e),function(e,r){r in t.defaults||(n[r]=e)}),n},toMonitorJSON:function(e){var t=this,n={};return r.each(t.toJSON(e),function(e,r){r in t.defaults&&(n[r]=e)}),n},toServerString:function(){return a.toServerString(this.toMonitorJSON())}});a.generateUniqueId=function(){function e(){return((1+Math.random())*65536|0).toString(16).substring(1)}return s.increment("generateUniqueId"),e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},a.generateUniqueCollectionId=function(e,t){var n="";return t=t||"",e.idSequence||(e.idSequence=0,e.forEach(function(n){var r=n.get("id")||"",i=+r.substr(t.length);e.idSequence<=i&&(e.idSequence=i+1)})),t+e.idSequence++},a.getRouter=function(){return a.defaultRouter||(a.defaultRouter=new a.Router,e.io&&a.defaultRouter.setGateway({socket:e.io.connect()})),a.defaultRouter},a.start=function(e,t){i.info("start",e),a.defaultServer=new a.Server,a.defaultServer.start(e,t)},a.stop=function(e){i.info("stop"),a.defaultServer.stop(e)},a.toServerString=function(e){var t=e.hostName;return e.appName&&(t+=":"+e.appName,e.appInstance&&(t+=":"+e.appInstance)),t},a.deepCopy=function(e,t){t=typeof t=="undefined"?u:t;if(typeof e!="object"&&typeof e!="function")return e;var n="[Object]";typeof e=="function"?n="[Function]":Array.isArray(e)&&(n="[Array]");if(t<=0)return n;var i=Array.isArray(e)?[]:{};for(var s in e){var o=e[s];typeof o=="object"||typeof o=="function"?i[s]=a.deepCopy(o,t-1):i[s]=o}return typeof e=="function"&&(r.isEmpty(i)?i=n:i=r.extend({constructor:n},i)),i},a.stringify=function(e,t,n){return n=typeof n=="undefined"?2:n,JSON.stringify(a.deepCopy(e,t),null,n)},a.setStatLoggerClass=function(e){a.getStatLogger=function(t){return new e(t)},s=a.getStatLogger("Monitor")},a.setLoggerClass=function(e){a.getLogger=function(t){return new e(t)},i=a.getLogger("Monitor")},a.List=n.Collection.extend({model:a});var f={appName:"unknown",serviceBasePort:42e3,portsToScan:20,allowExternalConnections:!1};t?(a.Config=require("config"),a.Config.setModuleDefaults("MonitorMin",f)):a.Config={MonitorMin:f},a._=r,a.Backbone=n,a.Cron=o,a.commonJS=t,t?module.exports=a:e.Monitor=a})(this),function(e){var t=e.Monitor||require("./Monitor"),n=t.commonJS?require("events").EventEmitter:t.Backbone.Events,r=t._,i=t.Stat=function(e){var t=this;t.module=e},s=i.prototype;i.eventRegex={},s.increment=function(e,t){t=r.isNumber(t)?t:1,i._emit(this.module,e,t,"c")},s.decrement=function(e,t){t=r.isNumber(t)?t:1,i._emit(this.module,e,t*-1,"c")},s.gauge=function(e,t){i._emit(this.module,e,t,"g")},s.time=function(e,t){i._emit(this.module,e,t,"ms")},i._emit=function(e,t,n,r){var s,o;for(s in i._events){o||(o=e+"."+t);var u=i.eventRegex[s];u||(u=i.eventRegex[s]=i._buildRegex(s)),u.test(o)&&i.emit(s,e,t,n,r)}},i._buildRegex=function(e){var t="",n="",r=e.length-1,i=!1;if(/^\/[^\/]*\/i*$/.test(e))/i$/.test(e)&&(n="i",e=e.replace(/i$/,"")),t="^"+e.replace(/^\//,"").replace(/\/$/,"")+"$";else{for(var s=0,o=e.length;s<o;s++){var u=e.substr(s,1);switch(u){case".":u="\\.";break;case"*":u=s===r?".*":"[^\\.]*";break;case"{":u="(",i=!0;break;case"}":u=")",i=!1;break;case",":i&&(u="|")}t+=u}t="^"+t+"$"}return new RegExp(t,n)},r.extend(i,n.prototype),t.setStatLoggerClass(i)}(this),function(e){var t=e.Monitor||require("./Monitor"),n=t.commonJS?require("events").EventEmitter:t.Backbone.Events,r=t.Stat,i=new r("Log"),s=t._,o=t.Log=function(e){var t=this;t.module=e},u=o.prototype;o.eventRegex={},["trace","debug","info","warn","error","fatal"].forEach(function(e){u[e]=function(t){o._emit(e,this.module,t,arguments)}}),o._emit=function(e,t,n,u){var a,f=e+"."+t+"."+n;i.increment(f);for(a in o._events){var l=o.eventRegex[a];l||(l=o.eventRegex[a]=r._buildRegex(a));if(l.test(f)){var c=s.toArray(u);c.splice(0,1,a,e,t,n),o.emit.apply(o,c)}}},s.extend(o,n.prototype),t.setLoggerClass(o)}(this),function(e){var t=e.Monitor||require("./Monitor"),n=t.getLogger("Probe"),r=t.getStatLogger("Probe"),i=t.Cron,s=t._,o=t.Backbone,u=t.Probe=o.Model.extend({defaults:{id:null},initialize:function(e,t){var r=this;n.info("init",r.toJSON(),e,t)},release:function(){var e=this;n.info("release",e.toJSON())},onControl:function(e,t,r){t=t||{},r=r||function(){};var i=this,s=i[e+"_control"],o;n.info("onControl",i.toJSON(),e,t);if(!s)return r({msg:"No control function: "+e});try{s.call(i,t,r)}catch(u){o="Error calling control: "+i.probeClass+":"+e,console.error(o,u),r({msg:o})}},ping_control:function(e,t){return t(null,"pong")}});u.classes={},u.extend=function(e){var t=this,n=o.Model.extend.apply(t,arguments);return e.probeClass&&(u.classes[e.probeClass]=n),n},u.List=o.Collection.extend({model:u})}(this),function(e){var t=e.Monitor||require("./Monitor"),n=t.Cron,r=t._,i=t.Backbone,s=t.getLogger("Connection"),o=t.getStatLogger("Connection"),u=t.Config,a=e.io||require("socket.io-client"),f=t.Probe,l=t.Connection=i.Model.extend({defaults:{hostName:"",hostPort:null,url:null,socket:null,gateway:!1,firewall:!1,remoteHostName:null,remoteAppName:null,remoteAppInstance:0,remotePID:0,remoteProbeClasses:[],remoteGateway:!1,remoteFirewall:!1},initialize:function(e){var t=this;t.connecting=!0,t.connected=!1,t.socketEvents=null,t.remoteProbeIdsByKey={},t.remoteProbesById={},t.incomingMonitorsById={},e.socket?t.bindConnectionEvents():e.url||e.hostName&&e.hostPort?t.connect():console.error("Connection must supply a socket, url, or host name/port")},connect:function(){var e=this,t=e.get("hostName"),n=e.get("hostPort"),r=e.get("url");s.info("connect",e.toJSON()),r||(r=e.attributes.url="http://"+t+":"+n);var i={transports:["websocket","xhr-polling"],"force new connection":!0,reconnect:!1},o=a.connect(r,i);e.set({socket:o}).bindConnectionEvents()},ping:function(e){var t=this;e=e||function(){};var n=function(){t.off("pong",n),e()};t.on("pong",n),t.emit("connection:ping")},disconnect:function(e){var t=this,n=t.get("socket");t.connecting=!1,t.connected=!1,s.info("disconnect",t.toJSON()),t.socketEvents&&(t.removeAllEvents(),n.disconnect(),t.trigger("disconnect",e))},isThisHost:function(e){var t=this,n=e.toLowerCase(),r=t.get("hostName"),i=t.get("remoteHostName");return r=r&&r.toLowerCase(),i=i&&i.toLowerCase(),n===r||n===i},emit:function(){var e=this,t=e.get("socket");s.info("emit",e.toJSON(),arguments),t.emit.apply(t,arguments)},addEvent:function(e,t){var n=this,r=n.get("socket");n.socketEvents=n.socketEvents||{};if(n.socketEvents[e])throw new Error("Event already connected: "+e);return r.on(e,t),n.socketEvents[e]=t,n},removeEvent:function(e){var t=this,n=t.get("socket");return t.socketEvents&&t.socketEvents[e]&&(n.removeListener(e,t.socketEvents[e]),delete t.socketEvents[e]),t},removeAllEvents:function(){var e=this,t=e.get("socket");for(var n in e.socketEvents)t.removeListener(n,e.socketEvents[n]);return e.socketEvents=null,e},bindConnectionEvents:function(){var e=this,n=e.get("socket");if(e.socketEvents)throw new Error("Already connected");e.socketEvents={},e.addEvent("connect_failed",function(){e.trigger("error","connect failed"),e.disconnect("connect failed")}),e.addEvent("disconnect",function(){e.disconnect("remote_disconnect")}),e.addEvent("error",function(t){e.trigger("error",t),e.disconnect("connect error")}),e.addEvent("probe:connect",e.probeConnect.bind(e)),e.addEvent("probe:disconnect",e.probeDisconnect.bind(e)),e.addEvent("probe:control",e.probeControl.bind(e)),e.addEvent("connection:ping",function(){n.emit("connection:pong")}),e.addEvent("connection:pong",function(){e.trigger("pong")}),e.addEvent("connection:info",function(t){e.set({remoteHostName:t.hostName,remoteAppName:t.appName,remoteAppInstance:t.appInstance,remotePID:t.pid,remoteProbeClasses:t.probeClasses,remoteGateway:t.gateway,remoteFirewall:t.firewall}),e.connecting=!1,e.connected=!0,e.trigger("connect")});var i=typeof process=="undefined"?1:process.pid,s=""+(typeof process=="undefined"?i:process.env.NODE_APP_INSTANCE||i);n.emit("connection:info",{hostName:t.getRouter().getHostName(),appName:u.MonitorMin.appName,appInstance:s,pid:i,probeClasses:r.keys(f.classes),gateway:e.get("gateway"),firewall:e.get("firewall")})},probeConnect:function(e,n){n=n||function(){};var r=this,i=t.getRouter(),o=r.get("gateway"),u=r.get("firewall");s.info("probeConnect",r.toJSON(),e);if(u)return n("firewalled");i.determineConnection(e,o,function(s,u){if(s)return n(s);if(u&&!o)return n("Not a gateway");var a=function(i,s){if(i)return n(i);var o=new t(e),u=s.get("id");o.set("probeId",u),r.incomingMonitorsById[u]=o,o.probe=s,o.probeChange=function(){r.emit("probe:change:"+u,s.changedAttributes())},n(null,s.toJSON()),s.on("change",o.probeChange)};u?i.connectExternal(e,u,a):i.connectInternal(e,a)})},probeDisconnect:function(e,n){n=n||function(){};var r=this,i=t.getRouter(),o=e.probeId,u=r.incomingMonitorsById[o],a=r.get("firewall");s.info("probeDisconnect",r.toJSON(),e);if(a)return n("firewalled");if(!u||!u.probe)return n("Probe not connected");var f=function(e){return e?n(e):(u.probe.off("change",u.probeChange),u.probe=u.probeChange=null,delete r.incomingMonitorsById[o],n(null))},l=u.probe;l&&l.connection?i.disconnectExternal(l.connection,o,f):i.disconnectInternal(o,f)},probeControl:function(e,n){n=n||function(){};var r=this,i=t.getRouter(),o=r.get("firewall");s.info("probeControl",r.toJSON(),e);if(o)return n("firewalled");var u=i.runningProbesById[e.probeId];if(!u){var a=r.incomingMonitorsById[e.probeId];return a?a.control(e.name,e.params,function(e,t){n(e,t)}):n("Probe id not found: "+e.probeId)}return u.onControl(e.name,e.params,n)}});l.List=i.Collection.extend({model:l})}(this),function(e){var t=e.Monitor||require("./Monitor"),n=t.Config,r=t._,i=t.Backbone,s=t.Connection,o=t.commonJS?require("http"):null,u=e.io||require("socket.io"),a=t.Server=i.Model.extend({initialize:function(e){var t=this;t.isListening=!1,t.connections=new s.List},start:function(e,t){typeof e=="function"&&(t=e,e=null),e=e||{},t=t||function(){};var r=this,i=r.get("server"),s,u=e.port||n.MonitorMin.serviceBasePort,a=e.attempt||1,f=n.MonitorMin.allowExternalConnections;if(a>n.MonitorMin.portsToScan)return s={err:"connect:failure",msg:"no ports available"},console.error("Server start",s),t(s);if(i)r.bindEvents(t);else{i=o.createServer(),i.on("error",function(e){r.get("port")||r.start({port:u+1,attempt:a+1},t)});var l=f?"0.0.0.0":"127.0.0.1";i.listen(u,l,function(){process.env.NODE_APP_INSTANCE||(process.env.NODE_APP_INSTANCE=""+(u-n.MonitorMin.serviceBasePort+1)),r.set({server:i,port:u}),r.bindEvents(t)})}},bindEvents:function(e){var n=this,r=n.get("server");r.on("clientError",function(e){console.error("Client error detected on server",e),n.trigger("error",e)}),r.on("close",function(e){r.hasEmittedClose=!0,n.stop()});var i={log:!1};n.socketServer=u.listen(r,i),n.socketServer.sockets.on("connection",function(e){var r=t.getRouter().addConnection({socket:e,gateway:n.get("gateway")});n.connections.add(r);var i=function(e){n.connections.remove(r),t.getRouter().removeConnection(r),r.off("disconnect",i)};r.on("disconnect",i)}),n.isListening=!0,e&&e(null),n.trigger("start")},stop:function(e){var n=this,r=n.get("server"),i=t.getRouter();return e=e||function(){},n.isListening?(n.connections.each(i.removeConnection,i),n.connections.reset(),n.isListening=!1,r.close(),n.trigger("stop"),e()):e()}});a.List=i.Collection.extend({model:a})}(this),function(e){var t=e.Monitor||require("./Monitor"),n=t.getLogger("Router"),r=t.getStatLogger("Router"),i=t.Cron,s=t._,o=t.Backbone,u=t.Config,a=t.Probe,f=t.Connection,l=t.Server,c=e.io||require("socket.io"),h=t.commonJS?require("os").hostname():null,p=t.Router=o.Model.extend({initialize:function(){var e=this;e.defaultGateway=null,e.firewall=!1,e.connections=new f.List,e.runningProbesByKey={},e.runningProbesById={}},setFirewall:function(e){var n=t.getRouter();n.firewall=e},setGateway:function(e){var t=this;return e.gateway=!1,e.firewall=!0,t.defaultGateway=t.addConnection(e)},getHostName:function(){var n=e.localStorage;return h||(n&&(h=n.hostName),h=h||t.generateUniqueId(),n&&(n.hostName=h)),h},setHostName:function(e){h=e},addConnection:function(e){var r=this;n.info("addConnection",r.toJSON(),e),s.isUndefined(e.firewall)&&(e=s.extend({},e,{firewall:r.firewall})),e.id=t.generateUniqueCollectionId(r.connections);var i=new f(e),o=function(){r.trigger("connection:add",i)},u=function(){r.removeConnection(i),i.off("connect",o),i.off("disconnect",o)};return i.on("connect",o),i.on("disconnect",u),r.connections.add(i),i},removeConnection:function(e){var t=this;n.info("removeConnection",t.toJSON(),e.toJSON()),e.disconnect("connection_removed"),t.connections.remove(e),t.trigger("connection:remove",e)},connectMonitor:function(e,t){t=t||function(){};var n=this,r=e.toMonitorJSON(),i=null,s=r.probeClass;if(!s)return t("probeClass must be set");n.determineConnection(r,!0,function(s,o){if(s)return t(s);var u=function(n,r){if(n)return t(n);i=r.toJSON(),i.probeId=i.id,delete i.id,e.probe=r,e.set(i,{silent:!0}),e.probeChange=function(){e.set(r.changedAttributes())},r.on("change",e.probeChange),t(null)};o?n.connectExternal(r,o,u):n.connectInternal(r,u)})},disconnectMonitor:function(e,t,n){n=n||function(){};var r=this,i=e.probe,s=e.get("probeId");if(!i)return n("Monitor must be connected");var o=function(r){return r?n(r):(i.off("change",e.probeChange),e.probe=e.probeChange=null,e.set({probeId:null}),n(null,t))};i.connection?r.disconnectExternal(i.connection,s,o):r.disconnectInternal(s,o)},buildProbeKey:function(e){var t=e.probeClass,n=e.initParams;return n&&s.keys(n).sort().forEach(function(e){t+=":"+e+"="+n[e]}),t},determineConnection:function(e,n,r){var i=this,s=null,o=e.probeClass,f=e.hostName,l=e.appName,c=e.appInstance,h=i.getHostName().toLowerCase(),p=u.appName,d=typeof process!="undefined"?process.env.NODE_APP_INSTANCE:"1",v=function(t){t||(delete e.hostName,delete e.appName,delete e.appInstance);var n=function(){o(),r(null,s)},i=function(e){o(),r({msg:"connection error",err:e})},o=function(){s.off("connect",n),s.off("error",i)};if(s&&s.connecting){s.on("connect",n),s.on("error",i);return}return s&&!s.connected?(s.on("connect",n),s.on("error",i),s.connect(r)):r(null,s)};f=f?f.toLowerCase():null;var m=!f||f===h,g=!l||l===p,y=!c||c===d;if(m&&g&&y)return a.classes[o]!=null?r(null,null):i.defaultGateway?(s=i.defaultGateway,v(!0)):r({err:'Probe class "'+o+'" not available in this process'});s=i.findConnection(f,l,c);if(s)return v();if(f&&n){i.addHostConnections(f,function(n){return n?r(n):(s=i.findConnection(f,l,c),s?v():i.defaultGateway?(s=i.defaultGateway,v(!0)):r({err:"No route to host: "+t.toServerString(e)}))});return}return f?r({msg:"Not a gateway to remote monitors"}):r({msg:"No host specified for app: "+l},null)},findConnection:function(e,t,n){var r=this,i=0;return r.connections.find(function(r){var i=!e||r.isThisHost(e),s=!t||t===r.get("remoteAppName"),o=!n||n===r.get("remoteAppInstance"),u=r.get("remoteFirewall");return!u&&i&&s&&o})},findConnections:function(e,t){var n=this;return n.connections.filter(function(n){var r=!e||n.isThisHost(e),i=!t||t===n.get("remoteAppName"),s=n.get("remoteFirewall");return!s&&r&&i})},addHostConnections:function(e,t){var n=this,r=[],i=u.MonitorMin.serviceBasePort,s=u.MonitorMin.serviceBasePort+u.MonitorMin.portsToScan-1;n.connections.each(function(t){var n=t.get("hostName").toLowerCase(),o=t.get("hostPort");n===e&&o>=i&&o<=s&&r.push(o)});var o=u.MonitorMin.portsToScan-r.length;if(o===0)return t();var a=function(){var e=this;e.off("connect disconnect error",a);if(--o===0)return t()};for(var f=i;f<=s;f++)if(r.indexOf(f)<0){var l=n.addConnection({hostName:e,hostPort:f});l.on("connect disconnect error",a,l)}},connectInternal:function(e,r){var i=this,s=i.buildProbeKey(e),o=e.probeClass,u=e.initParams,f=null;n.info("connectInternal",e);var l=function(e){setTimeout(function(){if(e){if(f){delete i.runningProbesByKey[s],delete i.runningProbesById[f.id];try{f.release()}catch(t){}}return r(e)}f.refCount++,r(null,f)},0)};f=i.runningProbesByKey[s];if(!f){var c=a.classes[o];if(!c)return l({msg:"Probe not available: "+o});var h={asyncInit:!1,callback:l};try{var p=t.deepCopy(u);f=new c(p,h),f.set({id:t.generateUniqueId()}),f.refCount=0,f.probeKey=s,i.runningProbesByKey[s]=f,i.runningProbesById[f.id]=f}catch(d){var v={msg:"Error instantiating probe "+o,error:d};return console.error(v),l(v)}if(h.asyncInit)return}l()},disconnectInternal:function(e,t){var n=this,r=n.runningProbesById[e];if(!r)return t("Probe not running");if(--r.refCount===0){try{r.release()}catch(i){}delete n.runningProbesByKey[r.probeKey],delete n.runningProbesById[e]}t(null,r)},connectExternal:function(e,n,r){var i=this,s=i.buildProbeKey(e),o=n.remoteProbeIdsByKey[s],u=n.remoteProbesById[o];if(!u){n.emit("probe:connect",e,function(i,f){return i?(console.error("Cannot connect to probeClass '"+e.probeClass+"' on "+t.toServerString(e),e,i),r(i)):(o=f.id,u=n.remoteProbesById[o],u?(u.refCount++,r(null,u)):(u=new a(f),u.refCount=1,u.connection=n,n.remoteProbeIdsByKey[s]=o,n.remoteProbesById[o]=u,n.addEvent("probe:change:"+o,function(e){u.set(e)}),r(null,u)))});return}return u.refCount++,r(null,u)},disconnectExternal:function(e,t,n){var r=this,i=e.remoteProbesById[t];if(!i)return n("Probe not running");if(--i.refCount===0)return i.release(),i.connection=null,delete e.remoteProbesById[t],delete e.remoteProbeIdsByKey[i.probeKey],e.removeEvent("probe:change:"+t),e.emit("probe:disconnect",{probeId:t},function(t){return t&&console.log("Probe disconnect error from host : "+e.get("hostName"),t),n(t)});n(null)}})}(this),function(e){var t=e.Monitor||require("./Monitor"),n=t.Backbone,r=t._,i="create",s="read",o="update",u="delete";t.Sync=function(e,t){if(!e)throw new Error("Sync class name must be provided");var n=new a(e,t);return function(e,t,r){return n._sync(e,t,r)}};var a=function(e,t){var n=this;n.className=e,n.options=t||{}};a.prototype._sync=function(e,r,o){var u=this;if(o.liveSync&&r instanceof n.Collection)return o.error(null,"Cannot liveSync with a collection");if(!r.has("id")){if(e!==i)return o.error(null,"ID element must be set.");r.set({id:t.generateUniqueId()},{silent:!0})}if(e===i&&o.liveSync){u._sync(e,r,{error:o.error,success:function(e){u._sync(s,r,o)}});return}var a=function(e,t){e?o.error(null,e):o.success(t)};if(r.syncMonitor||u.syncMonitor&&!o.liveSync){var f=r.syncMonitor||u.syncMonitor,l=u._getOpts(e,r);f.control(e,l,a)}else o.liveSync?u._connectInstanceMonitor(e,r,a):u._connectClassMonitor(e,r,a)},a.prototype._connectClassMonitor=function(e,n,r){var i=this,s=i._getMonitorParams(null),o=new t(s);o.connect(function(t){if(t)return r(t);i.syncMonitor=o;var s=i._getOpts(e,n);o.control(e,s,r)})},a.prototype._connectInstanceMonitor=function(e,n,i){var o=this,u,a=n.get("id"),f=function(e){if(e)return i(e);var t=function(){n.off("change",s),n.syncMonitor.off("change",o),n.syncMonitor.disconnect(),n.syncMonitor=null},s=function(e,i){i=i||{};if(r.isEqual(JSON.parse(JSON.stringify(n)),JSON.parse(JSON.stringify(n.syncMonitor.get("model")))))return;if(n.get("id")!==a)return t();i.isSyncChanging||n.save()},o=function(e,i){var s=n.syncMonitor.get("model");if(r.isEqual(JSON.parse(JSON.stringify(n)),JSON.parse(JSON.stringify(s))))return;var o=r.size(s)===0;(o||s.id!==a)&&t();var u={isSyncChanging:!0};o?n.clear(u):n.set(s,u)};n.on("change",s),n.syncMonitor.on("change",o),i(null,n.syncMonitor.get("model"))},l=o._getMonitorParams(a);u=new t(l),u.connect(function(t){if(t)return u.disconnect(),f(t);n.syncMonitor=u;if(e===s)return f();var r=o._getOpts(e,n);u.control(e,r,f)})},a.prototype._getOpts=function(e,t){var n={};switch(e){case s:case u:n.id=t.get("id");break;case i:case o:n.model=t.toJSON()}return n},a.prototype._getMonitorParams=function(e){var t=this,n=r.pick(t.options,"hostName","appName","appInstance");return n.probeClass="Sync",n.initParams={className:t.className},e&&(n.initParams.modelId=e),n}}(this),function(e){var t=e.Monitor||require("../Monitor"),n=t.Probe,r=t.Cron,i=t._,s=t.Backbone,o=1e3,u="* * * * * *",a=t.PollingProbe=n.extend({defaults:i.extend({},n.prototype.defaults,{pollInterval:null,cronPattern:u}),initialize:function(){var e=this,t=e.get("pollInterval"),i=e.get("cronPattern"),s=function(){e.poll()};n.prototype.initialize.apply(e,arguments),t==null&&i===u&&(t=o),e.poll();if(t!==0)if(t)e.timer=setInterval(s,t);else{if(!r)throw new Error("Cron is not available in this client");e.cronJob=new r.CronJob(i,s)}},release:function(){var e=this,t=e.cronJob?e.cronJob.timer:e.timer;e.cronJob&&!e.cronJob.initiated?setTimeout(function(){clearInterval(e.cronJob.timer)},1e3):e.timer&&clearInterval(t),e.timer=e.cron=null,n.prototype.release.apply(e,arguments)}})}(this),function(e){var t=e.Monitor||require("../Monitor"),n=t.Probe,r=t._,i=1e3,s=t.StreamProbe=n.extend({defaults:r.extend({},n.prototype.defaults,{bundle:[],interval:i,sequence:0}),initialize:function(){var e=this;n.prototype.initialize.apply(e,arguments),e.interval=e.get("interval"),e.queue=[],e.timer=null,e.lastSendTime=0},queueItem:function(e){var t=this,n=Date.now(),r=n-t.lastSendTime;t.queue.push(e),r>t.interval?t._send():t.timer||(t.timer=setTimeout(function(){t._send()},t.interval-r))},_send:function(){var e=this,t=Date.now();e.lastSendTime=t,e.set({bundle:e.queue,sequence:e.get("sequence")+1}),e.queue=[],e.timer&&(clearTimeout(e.timer),e.timer=null)}})}(this),function(root){var Monitor=root.Monitor||require("../Monitor"),_=Monitor._,Backbone=Monitor.Backbone,PollingProbe=Monitor.PollingProbe,DEFAULT_DEPTH=2,InspectProbe=Monitor.InspectProbe=PollingProbe.extend({probeClass:"Inspect",initialize:function(e){var t=this;t.key=e.key,typeof e.key=="undefined"&&(t.key=typeof window=="undefined"?"global":"window"),typeof e.depth=="undefined"?!e.key&&t.key==="window"?t.depth=1:t.depth=DEFAULT_DEPTH:t.depth=e.depth,t.value=t._evaluate(t.key),t.isModel=t.value instanceof Backbone.Model,t.set({value:Monitor.deepCopy(t.value,t.depth),isModel:t.isModel}),t.isModel?t.value.on("change",t.poll,t):PollingProbe.prototype.initialize.apply(t,arguments)},release:function(){var e=this;e.isModel?e.value.off("change",e.poll,e):PollingProbe.prototype.release.apply(e,arguments)},eval_control:function(e,t){var n=this;t=typeof t=="undefined"?DEFAULT_DEPTH:t;var r=n._evaluate(e);return Monitor.deepCopy(r,t)},_evaluate:function(expression){var t=this,value=null;try{value=eval(expression)}catch(e){throw new Error("Unable to evaluate: "+expression)}return value},poll:function(){var e=this,t=e.eval_control(e.key,e.depth);_.isEqual(t,e.get("value"))||e.set({value:t})}})}(this),function(e){var t=e.Monitor||require("../Monitor"),n=t._,r=t.StreamProbe,i=t.Stat,s="*",o=t.StatProbe=r.extend({probeClass:"Stat",defaults:n.extend({},r.prototype.defaults,{pattern:s}),initialize:function(){var e=this;r.prototype.initialize.apply(e,arguments),e.watcher=function(){e.queueItem.call(e,n.toArray(arguments))},i.on(e.get("pattern"),e.watcher)},release:function(){var e=this;i.off(e.get("pattern"),e.watcher)}})}(this),function(e){var t=e.Monitor||require("../Monitor"),n=t._,r=t.StreamProbe,i=t.Log,s="*",o=t.LogProbe=r.extend({probeClass:"Log",defaults:n.extend({},r.prototype.defaults,{pattern:s}),initialize:function(){var e=this;r.prototype.initialize.apply(e,arguments),e.watcher=function(){e.queueItem.call(e,n.toArray(arguments))},i.on(e.get("pattern"),e.watcher)},release:function(){var e=this;i.off(e.get("pattern"),e.watcher)}})}(this);